name: Scrape Greenhouse Sharded (Lovable ingest-jobs)

on:
  workflow_dispatch:
    inputs:
      shard_index:
        description: "Shard index to run (0..N-1). Leave empty for auto-rotation."
        required: false
        default: ""
      shard_size:
        description: "Companies per shard"
        required: true
        default: "100"

  schedule:
    # Every 15 minutes (UTC) = 96 runs/day
    - cron: "*/15 * * * *"

concurrency:
  group: greenhouse-sharded
  cancel-in-progress: false

jobs:
  run-shard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      # ✅ Write MASTER seed from GitHub Secret (this is your 3k–10k list)
      - name: Write master seed from GitHub secret
        shell: bash
        env:
          SEED_MASTER_JSON: ${{ secrets.SEED_MASTER_JSON }}
        run: |
          if [ -z "$SEED_MASTER_JSON" ]; then
            echo "❌ SEED_MASTER_JSON secret is missing"
            exit 1
          fi
          mkdir -p seeds
          echo "$SEED_MASTER_JSON" > seeds/greenhouse-master.json
          echo "✅ Master seed written: seeds/greenhouse-master.json"
          echo "✅ Master seed size:"
          wc -c seeds/greenhouse-master.json

      - name: Compute shard index (auto if empty)
        id: shard
        shell: bash
        env:
          INPUT_SHARD_INDEX: ${{ github.event.inputs.shard_index }}
        run: |
          if [ -n "$INPUT_SHARD_INDEX" ]; then
            echo "SHARD_INDEX=$INPUT_SHARD_INDEX" >> $GITHUB_OUTPUT
            echo "✅ Using manual shard index: $INPUT_SHARD_INDEX"
            exit 0
          fi

          # Auto: rotate shard by UTC minute-of-day / 15 => 0..95
          H=$(date -u +%H)
          M=$(date -u +%M)
          MINUTES=$((10#$H * 60 + 10#$M))
          SHARD_INDEX=$(( MINUTES / 15 ))

          echo "SHARD_INDEX=$SHARD_INDEX" >> $GITHUB_OUTPUT
          echo "✅ Auto shard index: $SHARD_INDEX (minuteOfDay=$MINUTES)"

      - name: Build runtime shard seed file
        id: buildseed
        shell: bash
        env:
          MASTER_SEED_FILE: seeds/greenhouse-master.json
          SHARD_INDEX: ${{ steps.shard.outputs.SHARD_INDEX }}
          SHARD_SIZE: ${{ github.event.inputs.shard_size || '100' }}
          OUT_SEED_FILE: seeds/_runtime_shard.json
        run: |
          node scripts/run_shard.js | tee shard_build.log
          SHARD_OUT=$(grep '^SHARD_OUT=' shard_build.log | sed 's/^SHARD_OUT=//')
          echo "SHARD_OUT=$SHARD_OUT" >> $GITHUB_OUTPUT
          echo "✅ Runtime shard seed: $SHARD_OUT"
          echo "✅ Runtime shard size:"
          wc -l $SHARD_OUT || true

      - name: Run scraper for this shard (last 24h)
        run: node extractors/scraper_send_to_ingest.js
        env:
          SEED_FILE: ${{ steps.buildseed.outputs.SHARD_OUT }}
          INGEST_JOBS_URL: ${{ secrets.INGEST_JOBS_URL }}
          SCRAPER_SECRET_KEY: ${{ secrets.SCRAPER_SECRET_KEY }}
          HOURS_BACK: "24"
          REQUEST_DELAY_MS: "150"
          MAX_RETRIES: "3"
