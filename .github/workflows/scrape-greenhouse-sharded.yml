name: Scrape Greenhouse Sharded (2 shards/run)

on:
  workflow_dispatch:
    inputs:
      start_shard_index:
        description: "Optional: force starting shard index (0..N-1). Leave empty for auto rotation."
        required: false
        default: ""
      shard_size:
        description: "Companies per shard (100 recommended)"
        required: true
        default: "100"
      shards_per_run:
        description: "How many shards to run per workflow run"
        required: true
        default: "2"

  schedule:
    # Every 10 minutes UTC => 144 runs/day
    - cron: "*/10 * * * *"

concurrency:
  group: greenhouse-sharded
  cancel-in-progress: false

jobs:
  run-shards:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Validate master seed JSON (repo file)
        run: node scripts/validate_json.js seeds/greenhouse-us-master.json

      - name: Compute total shards
        id: totals
        shell: bash
        env:
          SHARD_SIZE: ${{ github.event.inputs.shard_size || '100' }}
        run: |
          COUNT=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('seeds/greenhouse-us-master.json','utf8')); console.log(Array.isArray(j)?j.length:0)")
          if [ "$COUNT" -le 0 ]; then
            echo "❌ Master seed has 0 companies"
            exit 1
          fi

          TOTAL_SHARDS=$(( (COUNT + SHARD_SIZE - 1) / SHARD_SIZE ))

          echo "COMPANY_COUNT=$COUNT" >> $GITHUB_OUTPUT
          echo "TOTAL_SHARDS=$TOTAL_SHARDS" >> $GITHUB_OUTPUT

          echo "✅ Master companies: $COUNT"
          echo "✅ Shard size: $SHARD_SIZE"
          echo "✅ Total shards: $TOTAL_SHARDS"

      - name: Compute start shard index (auto or manual)
        id: start
        shell: bash
        env:
          INPUT_START: ${{ github.event.inputs.start_shard_index }}
          TOTAL_SHARDS: ${{ steps.totals.outputs.TOTAL_SHARDS }}
        run: |
          if [ -n "$INPUT_START" ]; then
            # manual mode
            echo "START_INDEX=$INPUT_START" >> $GITHUB_OUTPUT
            echo "✅ Manual start shard index: $INPUT_START"
            exit 0
          fi

          # auto mode:
          # runNumber = minuteOfDay / 10
          # shardSlotBase = runNumber * shardsPerRun
          # (actual shard index calculated later in loop)
          H=$(date -u +%H)
          M=$(date -u +%M)
          MINUTES=$((10#$H * 60 + 10#$M))
          RUN_NUMBER=$(( MINUTES / 10 ))

          echo "RUN_NUMBER=$RUN_NUMBER" >> $GITHUB_OUTPUT
          echo "✅ Auto runNumber: $RUN_NUMBER (minuteOfDay=$MINUTES)"

      - name: Run multiple shards this run
        shell: bash
        env:
          MASTER_SEED_FILE: seeds/greenhouse-us-master.json
          SHARD_SIZE: ${{ github.event.inputs.shard_size || '100' }}
          SHARDS_PER_RUN: ${{ github.event.inputs.shards_per_run || '2' }}
          TOTAL_SHARDS: ${{ steps.totals.outputs.TOTAL_SHARDS }}
          MANUAL_START: ${{ github.event.inputs.start_shard_index }}
          RUN_NUMBER: ${{ steps.start.outputs.RUN_NUMBER }}
          INGEST_JOBS_URL: ${{ secrets.INGEST_JOBS_URL }}
          SCRAPER_SECRET_KEY: ${{ secrets.SCRAPER_SECRET_KEY }}
        run: |
          set -e

          echo "✅ Running shardsPerRun=$SHARDS_PER_RUN totalShards=$TOTAL_SHARDS shardSize=$SHARD_SIZE"

          # Determine base slot
          if [ -n "$MANUAL_START" ]; then
            BASE_SLOT=$MANUAL_START
            echo "✅ Manual base slot: $BASE_SLOT"
          else
            BASE_SLOT=$(( RUN_NUMBER * SHARDS_PER_RUN ))
            echo "✅ Auto base slot: $BASE_SLOT"
          fi

          i=0
          while [ $i -lt $SHARDS_PER_RUN ]; do
            SHARD_INDEX=$(( (BASE_SLOT + i) % TOTAL_SHARDS ))
            OUT_SEED_FILE="seeds/_runtime_shard_${SHARD_INDEX}.json"

            echo "----------------------------------------------------"
            echo "✅ Shard $((i+1))/$SHARDS_PER_RUN -> SHARD_INDEX=$SHARD_INDEX"
            echo "----------------------------------------------------"

            MASTER_SEED_FILE="$MASTER_SEED_FILE" \
            SHARD_INDEX="$SHARD_INDEX" \
            SHARD_SIZE="$SHARD_SIZE" \
            OUT_SEED_FILE="$OUT_SEED_FILE" \
            node scripts/run_shard.js

            echo "✅ Runtime seed created: $OUT_SEED_FILE"

            # Run your existing scraper on this shard (last 24h)
            SEED_FILE="$OUT_SEED_FILE" \
            INGEST_JOBS_URL="$INGEST_JOBS_URL" \
            SCRAPER_SECRET_KEY="$SCRAPER_SECRET_KEY" \
            HOURS_BACK="24" \
            REQUEST_DELAY_MS="150" \
            MAX_RETRIES="3" \
            node extractors/scraper_send_to_ingest.js

            i=$((i+1))
          done

          echo "✅ Finished running $SHARDS_PER_RUN shard(s)."
